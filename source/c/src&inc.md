# 源文件与头文件（.c / .h）

在 C 语言工程中，程序通常由**多个源文件（.c）和多个头文件（.h）**共同组成。  
这种组织方式不是语法要求，而是长期工程实践中形成的规范。

本章重点说明：

- 源文件与头文件的职责区别  
- 为什么工程需要多个源文件和头文件  
- 如何进行合理的文件划分  
- 如何编写一个合格的头文件  

---

## 一、源文件（.c）的作用

源文件用于存放**函数和变量的具体实现**。

特点：

- 包含函数体  
- 包含实际可执行逻辑  
- 会被编译器编译为目标文件  

示例：

```c
// led.c
#include "led.h"

void led_on(void)
{
    HAL_GPIO_WritePin(GPIOA, GPIO_PIN_10, GPIO_PIN_SET);
}
```

📌 源文件关注的是：**功能如何实现**。

------

## 二、头文件（.h）的作用

头文件用于存放**对外可见的声明信息**。

特点：

- 不包含具体实现
- 不直接生成可执行代码
- 用于向其他文件提供接口信息

示例：

```c
// led.h
void led_on(void);
```

📌 头文件关注的是：**模块向外提供什么能力**。

------

## 三、为什么工程要使用多个 .c 和 .h 文件

### 1️⃣ 提高代码可维护性

当工程规模扩大时：

- 单文件代码难以阅读
- 修改风险增大
- 功能耦合严重

通过文件拆分：

- 每个模块职责清晰
- 修改局部功能不影响整体
- 错误更容易定位

------

### 2️⃣ 支持模块化设计

工程通常包含多类功能，例如：

- 外设驱动
- 算法逻辑
- 通信协议
- 系统调度

模块化后：

- 每类功能独立实现
- 模块之间通过头文件交互
- 降低模块间依赖强度

------

### 3️⃣ 便于协作与复用

- 多人可并行开发不同模块
- 模块可独立测试
- 模块可直接复用于其他工程

------

## 四、为什么源文件和头文件通常同名

常见做法：

```text
motor.c
motor.h
```

原因：

- 一个模块对应一组接口和实现
- 头文件声明接口
- 源文件实现接口
- 同名便于快速定位和维护

📌 这是工程约定俗成的规范，而非语言强制要求。

------

## 五、如何判断函数应放在哪个源文件中

判断依据不是代码数量，而是**功能归属**。

### 合理的划分原则：

- 同一源文件中的函数应完成同一类功能
- 函数之间具有较强的逻辑关联
- 对外接口数量应尽量少

示例：

```text
uart.c
- uart_init()
- uart_send()
- uart_receive()
```

不推荐的做法：

```text
utils.c
- uart_init()
- motor_set_speed()
- pid_calc()
```

📌 文件应按**功能模块**划分，而不是杂项集合。

------

## 六、头文件中可以包含的内容

### ✅ 推荐放入头文件的内容

#### 1️⃣ 函数声明

```c
void motor_init(void);
```

#### 2️⃣ 结构体定义

```c
typedef struct
{
    int speed;
    int direction;
} Motor_t;
```

#### 3️⃣ 枚举类型

```c
typedef enum
{
    MOTOR_STOP,
    MOTOR_RUN
} MotorState_t;
```

#### 4️⃣ 宏定义

```c
#define MOTOR_MAX_SPEED 1000
```

#### 5️⃣ 外部变量声明（谨慎使用）

```c
extern int motor_speed;
```

------

### ❌ 不应放入头文件的内容

- 函数实现
- 普通变量定义
- 具体业务逻辑代码

错误示例：

```c
int motor_speed = 0;   // 不应出现在头文件
```

------

## 七、头文件保护机制（必须）

每个头文件都应包含**头文件保护宏**，防止重复包含。

标准写法：

```c
#ifndef __MOTOR_H
#define __MOTOR_H

void motor_init(void);

#endif
```

作用：

- 防止多次包含导致重复定义
- 保证工程可正常编译

------

## 八、头文件的设计原则

一个合格的头文件应满足：

1. 只暴露必要接口
2. 不包含实现细节
3. 被任何源文件包含都能独立通过编译
4. 不依赖包含顺序

📌 头文件是模块的“使用说明书”。

------

## 九、源文件与头文件的协作方式

典型依赖关系：

```text
main.c
 ├── motor.h  → motor.c
 ├── uart.h   → uart.c
 └── sensor.h → sensor.c
```

说明：

- `main.c` 只通过头文件使用模块
- 不直接访问模块内部实现
- 模块内部修改不影响调用者

这称为 **接口与实现分离**。

------

## 十、main.c 的职责变化

初学阶段：

```c
int main(void)
{
    HAL_GPIO_WritePin(...);
    HAL_UART_Transmit(...);
}
```

工程化后：

```c
int main(void)
{
    system_init();
    motor_init();
    control_loop();
}
```

主函数只负责：

- 系统初始化
- 模块调度
- 程序流程组织

------

## 十一、小结

- `.c` 文件负责实现功能
- `.h` 文件负责声明接口
- 多文件结构是工程化的基础
- 良好的文件划分直接影响代码质量

掌握这一部分，意味着已经具备阅读和编写中小型 C 工程的能力。