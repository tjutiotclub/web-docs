# 选择结构 —— switch / case

当程序需要根据**同一个变量的不同取值**执行不同代码路径时，  
使用多层 `if / else if` 往往会导致结构冗长、逻辑不清晰。

C 语言提供了 `switch / case` 结构，用于实现**基于离散取值的分支选择**。

---

## switch 基本形式

基本语法如下：

```c
switch (expression)
{
    case value1:
        // 分支 1
        break;

    case value2:
        // 分支 2
        break;

    default:
        // 其他情况
        break;
}
````

其中：

* `expression` 为待判断的表达式
* `case` 后的值必须是**常量表达式**
* `break` 用于结束当前分支

---

## switch 的功能作用

| 结构名  | switch / case      |
| ---- | ------------------ |
| 结构作用 | 根据表达式的取值选择执行分支     |
| 判断方式 | 等值匹配（==）           |
| 支持类型 | 整型、字符型、枚举类型        |
| 工程意义 | 构建状态分发、命令解析、协议处理结构 |

---

## 执行流程说明

`switch` 的执行流程如下：

1. 计算 `expression` 的值
2. 将其与各个 `case` 值进行匹配
3. 跳转到匹配的 `case` 标签处
4. 继续向下执行，直到遇到 `break` 或结构结束

如果没有任何 `case` 匹配，则执行 `default` 分支。

---

## break 的作用与“贯穿执行”

### 1. 正常用法（推荐）

```c
case 1:
    func1();
    break;
```

`break` 用于**跳出 switch 结构**，防止继续执行后续分支。

---

### 2. 贯穿执行（fall-through）

如果省略 `break`：

```c
case 1:
    func1();
case 2:
    func2();
```

当 `case 1` 匹配时，会连续执行 `case 2` 的代码。

该特性在某些场景下是**刻意设计**的，而非错误。

---

## 函数工作原理

### 1. 功能行为层

`switch` 的作用是：

* 对一个变量进行多值判断
* 将程序分发到不同处理分支

其逻辑结构比多重 `if / else` 更直观。

---

### 2. 控制流分析

从控制流角度：

* `switch` 只计算一次表达式
* 通过跳转直接进入目标分支
* 执行路径清晰、分支集中

这是一种**集中式分支选择机制**。

---

### 3. 底层实现原理

在编译层面，`switch` 的实现方式可能包括：

* 顺序比较跳转（类似 if / else）
* 跳转表（Jump Table）

当 `case` 值连续且数量较多时，编译器通常会生成跳转表，从而提高执行效率。

---

### 4. 与 if / else 的工程对比

| 对比项   | if / else | switch     |
| ----- | --------- | ---------- |
| 判断方式  | 任意逻辑表达式   | 等值匹配       |
| 可读性   | 分支多时下降明显  | 分支集中，结构清晰  |
| 执行效率  | 依赖条件数量    | 可能使用跳转表    |
| 工程适用性 | 复杂条件判断    | 状态、命令、模式选择 |

---

## 与硬件 / 系统的关系

在嵌入式与系统开发中，`switch` 常用于：

* 状态机的状态分发
* 通信协议命令解析
* 菜单与模式选择
* 系统事件处理

例如：

```c
switch (system_state)
{
    case STATE_IDLE:
        idle_task();
        break;

    case STATE_RUN:
        run_task();
        break;

    case STATE_ERROR:
        error_handler();
        break;
}
```

此时，`switch` 实际上承担的是**状态调度器**的角色。

---

## 使用限制与注意事项

1. `switch` 不能直接用于浮点类型
2. `case` 标签必须是编译期常量
3. 忘记 `break` 是最常见的逻辑错误
4. 不适合用于范围判断（如 `x > 10`）

---

## 典型应用场景

基于其工作原理，`switch / case` 常用于：

* 状态机实现
* 协议帧类型解析
* 命令字分发
* 系统模式控制

---

## 小结

`switch` 的本质是：

> **对离散取值进行快速、集中式的控制流分发**

它是构建：

* 状态机
* 调度逻辑
* 系统控制框架

的重要工具，也是工程代码中最常见的结构之一。

当判断对象明确、分支固定时，`switch` 往往比 `if / else` 更合理。

